# Bitcoin之共识算法
Bitcoin是由peer-to-peer网络组成的电子现金系统，peer-to-peer网络中的完整节点从设计角度出发地位是平等的,而这些节点要组合在一起构成一个系统,则每个节点要求有两个功能:独立验证与沟通协作。

## 典型的拜占庭将军问题
要说起共识算法，就不得不说分布式系统的共识问题，而为了更好地理解分布式系统的共识问题，用一个故事来抽象是非常好的选择，所以，我还是简要陈述一下拜占庭将军问题吧。

拜占庭是东罗马帝国的首都，由于当时拜占庭罗马帝国国土辽阔，每支军队的驻地分隔很远，将军们只能靠信使传递消息。发生战争时，将军们必须制订统一的行动计划。然而，这些将军中有叛徒，叛徒希望通过影响统一行动计划的制定与传播，破坏忠诚的将军们一致的行动计划。因此，将军们必须有一个预定的方法协议，使所有忠诚的将军能够达成一致，而且少数几个叛徒不能使忠诚的将军做出错误的计划。**也就是说，拜占庭将军问题的实质就是要寻找一个方法，使得将军们能在一个有叛徒的非信任环境中建立对战斗计划的共识。**

## 分步式系统要解决的问题
在现实世界由计算机节点组成的分布式网络中，我们会遇到下列问题：
* 数据包在传输通道上不可靠
  * 网络拥堵产生的延时问题
  * 数据包丢失问题
  * 数据包被篡改的问题
* 节点不可靠
  * 发送错误的数据包
  * 重复发出相同的数据包而造成的数据泛滥
  * 失去通讯连接
  * 故意发出错误的数据包以达成非法目的
  
**先不管存在的这些问题，一个分布式系统存在的目的根据业务场景的不同而不同，但有一点是相同的：那就是各参与系统的节点对系统的状态达成一致。系统的状态要满足下面三个方面的要求：**
  * 一致性
  * 正确性
  * 时间有限性
  
也就是说对某一阶段的状态共识必须在一定时间内完成，对系统状态的共识要大多数节点认可且大多数节点的对状态的共识是一致的，才能满足某些实际场景的要求，而要达成这样的目标，就需要一种方法来统一系统的目标，我们称选定的某种方法为共识协议或者共识机制，共识机制对节点有两个维度的要求：独立性与沟通性。 
* 独立性是指：节点独立地对来自其它节点的数据进行校验，验证其正确性及有效性
* 沟通性是指：节点必须与其它节点（数量根据系统的要求而不同）建立连接，发送相关必须信息以促成系统状态一致。

当然实现共识协议用计算机术语表述就是共识算法，不要被共识机制，共识协议，共识算法这些乱七八糟的名词给弄昏了！因此，共识算法的核心是：在不可靠的通讯环境中，所有参与节点达成对系统状态的共识。

## Bitcoin中的共识算法
Bitcoin是一个点对点的电子现金系统，通过对等网络节点组成的peer-to-peer网络来完成系统状态的更新。所有节点共同维护一份全局可信的全局账本，这个全局账本并不是存在于某一个节点上，而是所有想诚实参与系统节点各有一个完整的账本数据备份。

那么，这些节点是如何对账本数据库的更新形成共识的呢？Bitcoin点对点网络对账本数据的共识是通过竞争记账的方式来实现的，最简单的故事表述是下面这个样子的：
* 所有节点都有3个塞子，点数是1，2，3，4，5，6
* 规则说：兄弟们，大家开始扔塞子，谁扔出来的点数小于或者等于9点（3+3+3），就算谁赢得这轮比赛的胜利，给这位兄弟发50个bitcoin奖励付出的努力
* 规则还说了：扔出来的结果必须发给所有其它兄弟验证，其它兄弟看到结果后，独立验证看看对不对，如果对，请把这个结果记录到自己的本本上，好开始进行下一回合的比赛了！不对，不管它，继续扔！

当然是我抽象的模型的简化版本，好方便记忆，实际中大致是这个样子的:
* 所有的独立节点组装好备选区块后，会有两个字段：一个是随机值，一个是目标值
* 所有节点通过 SHA256算法对整个区块数据进行计算，一般从0开始不断增大随机值，以使得SHA256的计算结果小于预定的目标值
* 谁先算出来的结点把计算出来的区块发送给网络中的其它结点进行验证，如果验证通过，则把这个区块记录进入自己的数据库账本中，如果没有通过，则继续进行自己的计算。

Bitcoin的共识算法又叫工作量证明算法：POW，本质上就是不断计算一块数据的HASH256结果。上面是极简核心版本，核心是理解SHA256算法的特点，因为SHA256的不可预测性及不可逆特性，要达成目标的预设值，就要经过一断的反复尝试计算，而不同的预设值就是难度值，如果难度越高，则需要进行尝试的次数越多，反之，则需要尝试的次数就越少。

用扔塞子来理解非常好，比如我们有2个塞子，根据概率论，如果要扔出的点数小于12点，一把就够了，而如果要扔出点数为2的结果，那么平均需要扔36次，这是两个极端，根据经验，你我知道，要扔出和越小的数字需要尝试的次数会越来越多，这个模型就是工作量证明的最底层的模型。

